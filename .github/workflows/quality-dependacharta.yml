name: Quality - DependaCharta Self Check

on:
  workflow_dispatch:
    inputs:
      upload_artifacts:
        description: 'Upload graph artifacts'
        required: false
        type: boolean
        default: true

# Explicit permissions
permissions:
  contents: read

jobs:
  self-check:
    name: Run DependaCharta on Own Codebase
    runs-on: ubuntu-24.04
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup mise
        uses: jdx/mise-action@v2

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: Make gradlew executable
        working-directory: analysis
        run: chmod +x gradlew

      - name: Build DependaCharta JAR
        working-directory: analysis
        run: ./gradlew build -x test

      - name: Create output directory
        run: mkdir -p graphs

      - name: Analyze analysis component
        run: |
          java -jar analysis/build/libs/dependacharta.jar \
            -d analysis/src/main/kotlin/de/maibornwolff/dependacharta \
            -o graphs \
            -f dependacharta-analysis

      - name: Analyze visualization component
        run: |
          java -jar analysis/build/libs/dependacharta.jar \
            -d visualization/src \
            -o graphs \
            -f dependacharta-visualization

      - name: List generated graphs
        run: |
          echo "Generated graph files:"
          ls -lh graphs/

      - name: Upload graph artifacts
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dependacharta-self-check-${{ github.run_id }}
          path: graphs/
          retention-days: 7
          if-no-files-found: error
