name: Quality - CodeCharta Analysis

on:
  workflow_dispatch:
    inputs:
      upload_artifacts:
        description: 'Upload analysis artifacts'
        required: false
        type: boolean
        default: true

# Explicit permissions
permissions:
  contents: read

jobs:
  analyze:
    name: Run CodeCharta Analysis
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run CodeCharta Analysis
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            codecharta/codecharta-analysis:latest \
            bash -c "
              git config --global --add safe.directory /workspace

              ccsh gitlogparser repo-scan \
                --repo-path . \
                -o git.cc.json \
                -nc

              ccsh unifiedparser . \
                -o unified.cc.json \
                -nc

              ccsh merge \
                git.cc.json \
                unified.cc.json \
                -o=dependacharta.cc.json.gz
            "

      - name: Display result info
        run: |
          echo "Generated CodeCharta analysis:"
          ls -lh dependacharta.cc.json.gz

      - name: Upload analysis artifact
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: codecharta-analysis-${{ github.run_id }}
          path: dependacharta.cc.json.gz
          retention-days: 7
          if-no-files-found: error
